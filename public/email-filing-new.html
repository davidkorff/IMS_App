<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Filing Configuration - IMS Integration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --danger-color: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
        }

        .header {
            background: var(--primary-color);
            color: white;
            padding: 1rem;
            margin-bottom: 2rem;
        }

        .nav-links {
            margin-bottom: 1rem;
        }

        .nav-links a {
            color: var(--accent-color);
            text-decoration: none;
            margin-right: 1rem;
        }

        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-not-configured { background: #6c757d; color: white; }
        .status-configuring { background: var(--warning-color); color: white; }
        .status-active { background: var(--success-color); color: white; }
        .status-error { background: var(--danger-color); color: white; }

        .setup-option {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .setup-option:hover {
            border-color: var(--accent-color);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.2);
        }

        .setup-option.selected {
            border-color: var(--accent-color);
            background: rgba(52, 152, 219, 0.1);
        }

        .setup-option .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--accent-color);
        }

        .setup-option h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .feature-list {
            text-align: left;
            margin: 1rem 0;
        }

        .feature-list li {
            margin-bottom: 0.5rem;
            color: #6c757d;
        }

        .feature-list .fa-check {
            color: var(--success-color);
            margin-right: 0.5rem;
        }

        .pricing {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-top: 1rem;
        }

        .wizard-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .step {
            padding: 0.5rem 1rem;
            margin: 0 0.5rem;
            border-radius: 20px;
            background: #e9ecef;
            color: #6c757d;
            font-weight: 500;
        }

        .step.active {
            background: var(--accent-color);
            color: white;
        }

        .step.completed {
            background: var(--success-color);
            color: white;
        }

        .hidden {
            display: none;
        }

        .email-address-box {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
        }

        .email-address {
            font-family: 'Courier New', monospace;
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--primary-color);
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            display: inline-block;
            margin: 1rem 0;
        }

        .azure-step {
            background: #f8f9fa;
            border-left: 4px solid var(--accent-color);
            padding: 1rem;
            margin: 1rem 0;
        }

        .loading-spinner {
            text-align: center;
            padding: 2rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="nav-links">
                <a href="/dashboard">‚Üê Back to Dashboard</a>
            </div>
            <h1><i class="fas fa-envelope"></i> Email Filing Configuration</h1>
            <p class="mb-0">Set up automatic email filing to IMS</p>
        </div>
    </div>

    <div class="container">
        <!-- Email Configuration Status -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title mb-1">Email Filing Status</h5>
                        <p class="text-muted mb-0" id="instance-name">Loading...</p>
                    </div>
                    <span class="status-badge status-not-configured" id="email-status">
                        <i class="fas fa-circle"></i> Not Configured
                    </span>
                </div>
            </div>
        </div>

        <!-- Configuration Content -->
        <div id="not-configured-view">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title text-center mb-4" id="setup-title">Choose Your Email Setup</h5>
                    
                    <div class="row">
                        <!-- Managed Email Option -->
                        <div class="col-md-6">
                            <div class="setup-option" data-option="managed">
                                <div class="icon">
                                    <i class="fas fa-cogs"></i>
                                </div>
                                <h4>We Manage Everything</h4>
                                <p class="text-muted">Simple setup - we handle all the technical details</p>
                                
                                <ul class="feature-list">
                                    <li><i class="fas fa-check"></i> Dedicated email address created for you</li>
                                    <li><i class="fas fa-check"></i> Zero technical setup required</li>
                                    <li><i class="fas fa-check"></i> We handle all maintenance</li>
                                    <li><i class="fas fa-check"></i> Ready in 30 seconds</li>
                                </ul>
                                
                                <div class="pricing">Contact 42consulting for pricing</div>
                            </div>
                        </div>

                        <!-- Client Email Option -->
                        <div class="col-md-6">
                            <div class="setup-option" data-option="client-hosted">
                                <div class="icon">
                                    <i class="fas fa-building"></i>
                                </div>
                                <h4>Use Your Own Email</h4>
                                <p class="text-muted">Connect your existing Office 365 email system</p>
                                
                                <ul class="feature-list">
                                    <li><i class="fas fa-check"></i> Your data stays in your environment</li>
                                    <li><i class="fas fa-check"></i> Use any email address you own</li>
                                    <li><i class="fas fa-check"></i> Maximum security & compliance</li>
                                    <li><i class="fas fa-check"></i> Requires Office 365 admin access</li>
                                </ul>
                                
                                <div class="pricing">Contact 42consulting for pricing</div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button class="btn btn-primary btn-lg" id="continue-setup" disabled>
                            <i class="fas fa-arrow-right"></i> Continue Setup
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Managed Email Setup -->
        <div id="managed-setup" class="hidden">
            <div class="wizard-steps">
                <div class="step active">Choose Option</div>
                <div class="step">Configure Settings</div>
                <div class="step">Create Email</div>
                <div class="step">Complete</div>
            </div>

            <div class="card">
                <div class="card-body">
                    <div id="managed-configure">
                        <h5 class="card-title text-center mb-4">Email Filing Settings</h5>
                        <p class="text-muted text-center">Configure where your documents will be filed in IMS</p>
                        
                        <form id="managed-settings-form" class="row justify-content-center">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Email Prefix</label>
                                    <input type="text" class="form-control" id="managed-email-prefix" 
                                           placeholder="e.g., docs, forms, quotes" required
                                           pattern="^[a-z0-9]([a-z0-9._-]{0,62}[a-z0-9])?$">
                                    <div class="form-text" id="managed-email-preview">Enter a prefix to see your email address</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">IMS Folder ID</label>
                                    <input type="number" class="form-control" id="managed-folder-id" 
                                           placeholder="0" value="0" min="0" max="999">
                                    <div class="form-text">Documents will be filed to this folder in IMS. Default is 0 (root folder).</div>
                                </div>
                                
                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-arrow-right"></i> Create Email Address
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <div id="managed-creating" class="text-center hidden">
                        <div class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <h5 class="mt-3">Creating Your Email Address...</h5>
                            <p class="text-muted">This will take just a moment</p>
                        </div>
                    </div>

                    <div id="managed-success" class="hidden">
                        <h4 class="text-success">
                            <i class="fas fa-check-circle"></i> Email Filing Configured!
                        </h4>
                        
                        <div class="email-address-box">
                            <p class="mb-2">Your dedicated email address:</p>
                            <div class="email-address" id="created-email-address">
                                <!-- Email address will be inserted here -->
                            </div>
                            <p class="text-muted mb-0">Send emails with control numbers to this address</p>
                        </div>

                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> How to Use</h6>
                            <ul class="text-start mb-0">
                                <li>Include the control number in the email subject (e.g., "ID:12345")</li>
                                <li>Attach any documents you want filed to IMS</li>
                                <li>Send, CC, or BCC your dedicated email address</li>
                                <li><strong>Works with TO, CC, and BCC:</strong> Your email will be processed regardless of recipient type</li>
                                <li>Documents will automatically appear in IMS within 5 minutes</li>
                            </ul>
                        </div>

                        <button class="btn btn-success" onclick="window.location.href = `/instance/${instanceId}/email-filing`">
                            <i class="fas fa-check"></i> View All Configurations
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Client-Hosted Setup -->
        <div id="client-setup" class="hidden">
            <div class="wizard-steps">
                <div class="step completed">Choose Option</div>
                <div class="step active">Azure Setup</div>
                <div class="step">Test Connection</div>
                <div class="step">Complete</div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Connect Your Office 365 Email</h5>
                    <p class="text-muted">Follow these steps to connect your email system:</p>

                    <!-- Step-by-step Azure setup guide -->
                    <div class="azure-step">
                        <h6><i class="fas fa-1"></i> Azure App Registration</h6>
                        <p>Create an Azure app registration to allow secure access to your email.</p>
                        <a href="https://portal.azure.com" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-external-link-alt"></i> Open Azure Portal
                        </a>
                    </div>

                    <!-- Credential input form -->
                    <form id="client-credentials-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Application (Client) ID</label>
                                    <input type="text" class="form-control" id="client-id" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Directory (Tenant) ID</label>
                                    <input type="text" class="form-control" id="tenant-id" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Client Secret</label>
                            <input type="password" class="form-control" id="client-secret" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Email Address to Monitor</label>
                            <input type="email" class="form-control" id="email-address" 
                                   placeholder="documents@yourcompany.com" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">IMS Folder ID</label>
                            <input type="number" class="form-control" id="folder-id" 
                                   placeholder="0" value="0" min="0" max="999">
                            <div class="form-text">Documents will be filed to this folder in IMS. Default is 0 (root folder).</div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plug"></i> Test Connection
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Configuration Display -->
        <div id="configured-view" class="hidden">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Email Filing Configuration</h5>
                        <button class="btn btn-outline-primary" id="add-config" onclick="showAddConfigOptions()">
                            <i class="fas fa-plus"></i> Add Another Configuration
                        </button>
                    </div>
                    
                    <div id="config-list">
                        <!-- Configuration list will be loaded here -->
                    </div>

                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <button class="btn btn-primary me-2" id="process-emails">
                                    <i class="fas fa-envelope-open"></i> Process Emails Now
                                </button>
                                <button class="btn btn-outline-success me-2" id="test-all-configs">
                                    <i class="fas fa-vial"></i> Test All Configurations
                                </button>
                            </div>
                            <div class="text-end">
                                <small class="text-muted d-block">Background Email Monitoring:</small>
                                <button class="btn btn-sm btn-outline-primary" id="toggle-monitoring" onclick="toggleEmailMonitoring()">
                                    <i class="fas fa-play" id="monitoring-icon"></i>
                                    <span id="monitoring-text">Start Monitoring</span>
                                </button>
                                <div class="mt-1">
                                    <small class="text-success" id="monitoring-status">‚úÖ Running every 5 minutes</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Control Number Patterns Management -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Control Number Pattern Settings</h5>
                    <p class="text-muted">Customize how control numbers are extracted from email subjects for each configuration.</p>
                    
                    <div id="pattern-configs">
                        <!-- Pattern configurations will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Email Processing Stats -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Recent Email Processing</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshEmailLogs()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div id="email-stats">
                        <!-- Stats will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Number Patterns Modal -->
    <div class="modal fade" id="patternsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Control Number Patterns</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> How Control Number Patterns Work</h6>
                        <ul class="mb-0">
                            <li>Patterns are tested in order from top to bottom</li>
                            <li>The first pattern that matches will be used</li>
                            <li>Use parentheses () to capture the control number</li>
                            <li>Example: <code>ID:\\s*(\\d{1,9})\\b</code> matches "ID:12345"</li>
                        </ul>
                    </div>

                    <form id="patterns-form">
                        <input type="hidden" id="edit-config-id" value="">
                        
                        <div class="mb-3">
                            <label class="form-label">Email Configuration</label>
                            <input type="text" class="form-control" id="edit-config-display" readonly>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">
                                Control Number Patterns
                                <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="showRegexHelp()" title="Learn about regex patterns">
                                    <i class="fas fa-question-circle"></i> Regex Help
                                </button>
                            </label>
                            <div id="pattern-list">
                                <!-- Pattern inputs will be added here -->
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addPatternField()">
                                <i class="fas fa-plus"></i> Add Pattern
                            </button>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Test Your Patterns</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="test-subject" 
                                       placeholder="Enter test email subject (e.g., 'FW: check quote ID:12345')">
                                <button type="button" class="btn btn-outline-secondary" onclick="testPatterns()">
                                    <i class="fas fa-flask"></i> Test
                                </button>
                            </div>
                            <div id="test-result" class="mt-2"></div>
                        </div>

                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-info" onclick="loadDefaultPatterns()">
                                <i class="fas fa-undo"></i> Reset to Default (ID: patterns)
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePatterns()">
                        <i class="fas fa-save"></i> Save Patterns
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Regex Help Modal -->
    <div class="modal fade" id="regexHelpModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-graduation-cap"></i> Regular Expression (Regex) Guide</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-info-circle text-primary"></i> What are Regular Expressions?</h6>
                            <p>Regular expressions (regex) are patterns that help find specific text. For email filing, we use them to find control numbers in email subjects.</p>
                            
                            <h6 class="mt-4"><i class="fas fa-cogs text-success"></i> Basic Building Blocks</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr><th>Pattern</th><th>Meaning</th><th>Example</th></tr>
                                    </thead>
                                    <tbody>
                                        <tr><td><code>\\d</code></td><td>Any digit (0-9)</td><td>Matches "5" in "ID:5"</td></tr>
                                        <tr><td><code>\\d{3}</code></td><td>Exactly 3 digits</td><td>Matches "123" in "ID:123"</td></tr>
                                        <tr><td><code>\\d{1,9}</code></td><td>1 to 9 digits</td><td>Matches "12345" in "ID:12345"</td></tr>
                                        <tr><td><code>\\s</code></td><td>Any whitespace</td><td>Matches space in "ID: 123"</td></tr>
                                        <tr><td><code>\\s*</code></td><td>Zero or more spaces</td><td>Matches "ID:123" and "ID: 123"</td></tr>
                                        <tr><td><code>\\b</code></td><td>Word boundary</td><td>Prevents matching partial words</td></tr>
                                        <tr><td><code>( )</code></td><td>Capture group</td><td>Captures the control number</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <h6 class="mt-4"><i class="fas fa-search text-warning"></i> Position Anchors</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr><th>Pattern</th><th>Meaning</th><th>Example</th></tr>
                                    </thead>
                                    <tbody>
                                        <tr><td><code>^</code></td><td>Start of line</td><td><code>^ID:</code> only matches if "ID:" is at the beginning</td></tr>
                                        <tr><td><code>$</code></td><td>End of line</td><td><code>123$</code> only matches if "123" is at the end</td></tr>
                                        <tr><td><code>?:</code></td><td>Non-capturing group</td><td><code>(?:RE:\\s*)?</code> optionally matches "RE: "</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6><i class="fas fa-lightbulb text-warning"></i> Common Control Number Patterns</h6>
                            
                            <div class="alert alert-success">
                                <h6>üìß Default ID: Pattern</h6>
                                <code>ID:\\s*(\\d{1,9})\\b</code>
                                <p class="small mb-0 mt-1">Matches: "ID:12345", "ID: 67890", "Quote ID:999"</p>
                            </div>
                            
                            <div class="alert alert-info">
                                <h6>üìù Quote Pattern</h6>
                                <code>Quote\\s*#?\\s*(\\d{1,9})\\b</code>
                                <p class="small mb-0 mt-1">Matches: "Quote 12345", "Quote #67890", "Quote# 999"</p>
                            </div>
                            
                            <div class="alert alert-warning">
                                <h6>üìã Policy Pattern</h6>
                                <code>Policy\\s*#\\s*(\\d{1,9})\\b</code>
                                <p class="small mb-0 mt-1">Matches: "Policy # 12345", "Policy #67890"</p>
                            </div>
                            
                            <div class="alert alert-secondary">
                                <h6>üè∑Ô∏è Reference Pattern</h6>
                                <code>\\[([A-Z0-9]{5,10})\\]</code>
                                <p class="small mb-0 mt-1">Matches: "[ABC123]", "[REF12345]"</p>
                            </div>
                            
                            <h6 class="mt-4"><i class="fas fa-tools text-primary"></i> Pattern Building Tips</h6>
                            <ul class="small">
                                <li><strong>Start Simple:</strong> Begin with basic patterns like <code>ID:(\\d+)</code></li>
                                <li><strong>Add Flexibility:</strong> Use <code>\\s*</code> to allow optional spaces</li>
                                <li><strong>Use Boundaries:</strong> Add <code>\\b</code> to prevent partial matches</li>
                                <li><strong>Test Often:</strong> Use the test feature to verify your patterns</li>
                                <li><strong>Order Matters:</strong> Put most specific patterns first</li>
                            </ul>
                            
                            <h6 class="mt-4"><i class="fas fa-exclamation-triangle text-danger"></i> Common Mistakes</h6>
                            <ul class="small text-danger">
                                <li>Forgetting parentheses <code>()</code> to capture the number</li>
                                <li>Using <code>*</code> instead of <code>+</code> (matches zero vs one or more)</li>
                                <li>Not escaping special characters like <code>.</code> or <code>$</code></li>
                                <li>Making patterns too broad (matching unintended text)</li>
                            </ul>
                            
                            <div class="alert alert-info mt-3">
                                <h6><i class="fas fa-rocket"></i> Pro Tip</h6>
                                <p class="small mb-0">Test your patterns at <a href="https://regex101.com" target="_blank">regex101.com</a> with real email subjects before adding them!</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="copyDefaultPattern()">
                        <i class="fas fa-copy"></i> Copy Default Pattern
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/global-auth.js"></script>
    <script>
        let instanceId = null;
        let selectedOption = null;

        // Get instance ID from URL
        function getInstanceId() {
            const path = window.location.pathname;
            const match = path.match(/\/instance\/(\d+)/);
            return match ? parseInt(match[1]) : null;
        }

        // Load page data
        async function loadPageData() {
            instanceId = getInstanceId();
            if (!instanceId) {
                alert('Invalid instance ID');
                return;
            }

            // Check for type parameter in URL
            const urlParams = new URLSearchParams(window.location.search);
            const configType = urlParams.get('type');
            
            if (configType === 'managed' || configType === 'client-hosted') {
                // Auto-select the option and proceed
                selectedOption = configType;
                document.querySelector(`[data-option="${configType}"]`).classList.add('selected');
                document.getElementById('continue-setup').disabled = false;
                
                // Auto-proceed to setup after a short delay
                setTimeout(() => {
                    document.getElementById('continue-setup').click();
                }, 500);
            }

            try {
                // Load instance details
                const instanceResponse = await fetch(`/api/instances/${instanceId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const instanceData = await instanceResponse.json();
                
                if (instanceData.success) {
                    document.getElementById('instance-name').textContent = instanceData.instance.name;
                    // Always show as not configured for new setup
                    updateEmailStatus('not_configured');
                }
            } catch (error) {
                console.error('Error loading page data:', error);
            }
        }

        // Update email status display
        function updateEmailStatus(status) {
            const statusElement = document.getElementById('email-status');
            statusElement.className = `status-badge status-${status}`;
            
            const statusText = {
                'not_configured': 'Not Configured',
                'configuring': 'Configuring...',
                'active': 'Active',
                'error': 'Error'
            };
            
            statusElement.innerHTML = `<i class="fas fa-circle"></i> ${statusText[status] || status}`;
            
            // Show appropriate view
            if (status === 'not_configured') {
                document.getElementById('not-configured-view').classList.remove('hidden');
                document.getElementById('configured-view').classList.add('hidden');
            } else {
                document.getElementById('not-configured-view').classList.add('hidden');
                document.getElementById('configured-view').classList.remove('hidden');
                // Load configurations when showing the configured view
                loadEmailConfig();
            }
        }

        // Load email configuration details
        async function loadEmailConfig() {
            await displayConfigDetails();
            await displayPatternConfigs();
            await loadEmailLogs();
        }

        // Display pattern configurations section
        async function displayPatternConfigs() {
            try {
                console.log('Loading pattern configurations for instance:', instanceId);
                const response = await fetch(`/api/email-filing/config/${instanceId}/all`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                console.log('Pattern configs response:', data);
                
                const patternConfigsDiv = document.getElementById('pattern-configs');
                
                if (data.success && data.configs && data.configs.length > 0) {
                    patternConfigsDiv.innerHTML = data.configs.map(config => {
                        const configType = config.config_type === 'managed' ? 'Managed by Us' : 'Your Email System';
                        const patterns = config.control_number_patterns || ['ID:\\\\s*(\\\\d{1,9})\\\\b'];
                        
                        return `
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1">${configType}</h6>
                                            <small class="text-muted">${config.email_address}</small>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editPatterns('${config.id}', '${configType}', '${config.email_address}')">
                                            <i class="fas fa-edit"></i> Edit Patterns
                                        </button>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted"><strong>Current Patterns:</strong></small>
                                        <ul class="small mb-0 mt-1">
                                            ${patterns.slice(0, 3).map((pattern, index) => 
                                                `<li><code>${pattern}</code></li>`
                                            ).join('')}
                                            ${patterns.length > 3 ? `<li class="text-muted">... and ${patterns.length - 3} more</li>` : ''}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    patternConfigsDiv.innerHTML = '<p class="text-muted">No email configurations found. Set up email filing first.</p>';
                }
            } catch (error) {
                console.error('Error loading pattern configurations:', error);
                document.getElementById('pattern-configs').innerHTML = '<p class="text-danger">Error loading pattern configurations.</p>';
            }
        }

        // Display configuration details
        async function displayConfigDetails() {
            try {
                const response = await fetch(`/api/email-filing/config/${instanceId}/all`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                
                if (data.success && data.configs && data.configs.length > 0) {
                    const configListDiv = document.getElementById('config-list');
                    
                    configListDiv.innerHTML = data.configs.map(config => {
                        const configType = config.config_type === 'managed' ? 'Managed by Us' : 'Your Email System';
                        const lastTested = config.last_tested_at ? new Date(config.last_tested_at).toLocaleString() : 'Never';
                        const statusClass = config.test_status === 'success' ? 'success' : 'danger';
                        
                        return `
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="card-title">${configType}</h6>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <p class="mb-1"><strong>Email Address:</strong> ${config.email_address}</p>
                                                    <p class="mb-1"><strong>Last Tested:</strong> ${lastTested}</p>
                                                </div>
                                                <div class="col-md-6">
                                                    <p class="mb-1"><strong>Auto Extract:</strong> ${config.auto_extract_control_numbers ? 'Yes' : 'No'}</p>
                                                    <p class="mb-1"><strong>Include Attachments:</strong> ${config.include_attachments ? 'Yes' : 'No'}</p>
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    <strong>Control Patterns:</strong> 
                                                    ${config.control_number_patterns && config.control_number_patterns.length > 0 
                                                        ? config.control_number_patterns.slice(0, 2).join(', ') + (config.control_number_patterns.length > 2 ? '...' : '')
                                                        : 'Default ID: patterns'}
                                                </small>
                                            </div>
                                            <span class="badge bg-${statusClass}">${config.test_status || 'Unknown'}</span>
                                        </div>
                                        <div class="btn-group ms-3">
                                            <button class="btn btn-sm btn-outline-secondary" onclick="editPatterns('${config.id}', '${configType}', '${config.email_address}')" title="Edit Control Number Patterns">
                                                <i class="fas fa-edit"></i> Patterns
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" onclick="testConfig('${config.id}')">
                                                <i class="fas fa-vial"></i> Test
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteConfig('${config.id}')">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    document.getElementById('config-list').innerHTML = '<p class="text-muted">No configurations found.</p>';
                }
            } catch (error) {
                console.error('Error loading configurations:', error);
                document.getElementById('config-list').innerHTML = '<p class="text-danger">Error loading configurations.</p>';
            }
        }

        // Setup option selection
        document.querySelectorAll('.setup-option').forEach(option => {
            option.addEventListener('click', function() {
                // Remove previous selection
                document.querySelectorAll('.setup-option').forEach(opt => opt.classList.remove('selected'));
                
                // Add selection to clicked option
                this.classList.add('selected');
                selectedOption = this.dataset.option;
                
                // Enable continue button
                document.getElementById('continue-setup').disabled = false;
            });
        });

        // Continue setup
        document.getElementById('continue-setup').addEventListener('click', function() {
            if (selectedOption === 'managed') {
                startManagedSetup();
            } else if (selectedOption === 'client-hosted') {
                startClientSetup();
            }
        });

        // Start managed email setup
        function startManagedSetup() {
            document.getElementById('not-configured-view').classList.add('hidden');
            document.getElementById('managed-setup').classList.remove('hidden');
            // Show the configuration form first
            document.getElementById('managed-configure').classList.remove('hidden');
        }

        // Managed settings form submission
        document.getElementById('managed-settings-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Hide form and show loading
            document.getElementById('managed-configure').classList.add('hidden');
            document.getElementById('managed-creating').classList.remove('hidden');
            
            const emailPrefix = document.getElementById('managed-email-prefix').value.toLowerCase();
            const folderId = parseInt(document.getElementById('managed-folder-id').value) || 0;
            
            try {
                const response = await fetch(`/api/email-filing/setup-managed/${instanceId}`, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        email_prefix: emailPrefix,
                        default_folder_id: folderId 
                    })
                });
                
                const data = await response.json();
                
                console.log('Setup managed response:', data);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${data.message || 'Setup failed'}`);
                }
                
                if (data.success) {
                    document.getElementById('managed-creating').classList.add('hidden');
                    document.getElementById('managed-success').classList.remove('hidden');
                    document.getElementById('created-email-address').textContent = data.email_address;
                    
                    // Update success message if already configured
                    if (data.already_configured) {
                        document.querySelector('#managed-success h4').innerHTML = 
                            '<i class="fas fa-check-circle"></i> Email Filing Already Configured!';
                    }
                    
                    updateEmailStatus('active');
                } else {
                    throw new Error(data.message || 'Setup failed');
                }
            } catch (error) {
                alert('Error setting up managed email: ' + error.message);
                console.error('Managed setup error:', error);
                // Show form again on error
                document.getElementById('managed-creating').classList.add('hidden');
                document.getElementById('managed-configure').classList.remove('hidden');
            }
        });

        // Start client-hosted setup
        function startClientSetup() {
            document.getElementById('not-configured-view').classList.add('hidden');
            document.getElementById('client-setup').classList.remove('hidden');
        }

        // Client credentials form submission
        document.getElementById('client-credentials-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                client_id: document.getElementById('client-id').value,
                tenant_id: document.getElementById('tenant-id').value,
                client_secret: document.getElementById('client-secret').value,
                email_address: document.getElementById('email-address').value,
                default_folder_id: parseInt(document.getElementById('folder-id').value) || 0
            };
            
            try {
                const response = await fetch(`/api/email-filing/setup-client-hosted/${instanceId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Configuration saved and tested successfully!');
                    window.location.reload();
                } else {
                    alert('Configuration failed: ' + data.message);
                }
            } catch (error) {
                alert('Error saving configuration: ' + error.message);
                console.error('Client setup error:', error);
            }
        });

        // Process emails now
        document.getElementById('process-emails')?.addEventListener('click', async function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            try {
                const response = await fetch(`/api/email-filing/process-emails/${instanceId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Email processing completed successfully!');
                } else {
                    alert('Email processing failed: ' + data.details);
                }
            } catch (error) {
                alert('Error processing emails: ' + error.message);
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-envelope-open"></i> Process Emails Now';
            }
        });

        // Test configuration
        document.getElementById('test-config')?.addEventListener('click', async function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            
            try {
                const response = await fetch(`/api/email-filing/test-config/${instanceId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Configuration test passed!');
                } else {
                    alert('Configuration test failed: ' + data.message);
                }
            } catch (error) {
                alert('Error testing configuration: ' + error.message);
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-vial"></i> Test Configuration';
            }
        });

        // Show add configuration options
        function showAddConfigOptions() {
            document.getElementById('configured-view').classList.add('hidden');
            document.getElementById('not-configured-view').classList.remove('hidden');
            document.getElementById('setup-title').textContent = 'Add Another Email Configuration';
        }

        // Test individual configuration
        async function testConfig(configId) {
            try {
                const response = await fetch(`/api/email-filing/test-config/${instanceId}/${configId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Configuration test passed!');
                    await displayConfigDetails(); // Refresh the display
                } else {
                    alert('Configuration test failed: ' + data.message);
                }
            } catch (error) {
                alert('Error testing configuration: ' + error.message);
            }
        }

        // Delete configuration
        async function deleteConfig(configId) {
            if (!confirm('Are you sure you want to delete this email configuration?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/email-filing/config/${instanceId}/${configId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Configuration deleted successfully!');
                    await loadPageData(); // Refresh the entire page
                } else {
                    alert('Failed to delete configuration: ' + data.message);
                }
            } catch (error) {
                alert('Error deleting configuration: ' + error.message);
            }
        }

        // Test all configurations
        document.getElementById('test-all-configs')?.addEventListener('click', async function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing All...';
            
            try {
                const response = await fetch(`/api/email-filing/test-all-configs/${instanceId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`All configurations tested. ${data.results.passed}/${data.results.total} passed.`);
                    await displayConfigDetails(); // Refresh the display
                } else {
                    alert('Error testing configurations: ' + data.message);
                }
            } catch (error) {
                alert('Error testing configurations: ' + error.message);
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-vial"></i> Test All Configurations';
            }
        });

        // Edit control number patterns
        async function editPatterns(configId, configType, emailAddress) {
            try {
                document.getElementById('edit-config-id').value = configId;
                document.getElementById('edit-config-display').value = `${configType} - ${emailAddress}`;
                
                // Load current patterns
                const response = await fetch(`/api/email-filing/config/${instanceId}/${configId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                
                if (data.success && data.config) {
                    loadPatternsIntoForm(data.config.control_number_patterns || getDefaultPatterns());
                } else {
                    loadPatternsIntoForm(getDefaultPatterns());
                }
                
                const modal = new bootstrap.Modal(document.getElementById('patternsModal'));
                modal.show();
            } catch (error) {
                alert('Error loading patterns: ' + error.message);
            }
        }

        // Get default control number patterns
        function getDefaultPatterns() {
            return [
                'ID:\\\\s*(\\\\d{1,9})\\\\b',           // Primary: Look for "ID:" followed by control number
                '^(?:RE:\\\\s*)?ID:\\\\s*(\\\\d{1,9})\\\\b', // Secondary: "RE: ID:10000" at start of subject  
                '\\\\bID:\\\\s*(\\\\d{1,9})\\\\b'          // Fallback: "ID:" pattern anywhere in content
            ];
        }

        // Load patterns into the form
        function loadPatternsIntoForm(patterns) {
            const patternList = document.getElementById('pattern-list');
            patternList.innerHTML = '';
            
            patterns.forEach((pattern, index) => {
                addPatternField(pattern);
            });
            
            if (patterns.length === 0) {
                addPatternField();
            }
        }

        // Add a pattern input field
        function addPatternField(value = '') {
            const patternList = document.getElementById('pattern-list');
            const index = patternList.children.length;
            
            const div = document.createElement('div');
            div.className = 'input-group mb-2';
            div.innerHTML = `
                <span class="input-group-text">${index + 1}</span>
                <input type="text" class="form-control pattern-input" value="${value}" 
                       placeholder="e.g., ID:\\\\s*(\\\\d{1,9})\\\\b">
                <button type="button" class="btn btn-outline-danger" onclick="removePatternField(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            patternList.appendChild(div);
        }

        // Remove a pattern field
        function removePatternField(button) {
            const patternList = document.getElementById('pattern-list');
            if (patternList.children.length > 1) {
                button.parentElement.remove();
                updatePatternNumbers();
            }
        }

        // Update pattern numbers
        function updatePatternNumbers() {
            const patternList = document.getElementById('pattern-list');
            Array.from(patternList.children).forEach((div, index) => {
                const span = div.querySelector('.input-group-text');
                span.textContent = index + 1;
            });
        }

        // Test patterns against a subject
        function testPatterns() {
            const testSubject = document.getElementById('test-subject').value;
            const resultDiv = document.getElementById('test-result');
            
            if (!testSubject.trim()) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please enter a test subject</div>';
                return;
            }
            
            const patterns = Array.from(document.querySelectorAll('.pattern-input'))
                .map(input => input.value.trim())
                .filter(pattern => pattern.length > 0);
            
            if (patterns.length === 0) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please add at least one pattern</div>';
                return;
            }
            
            let foundMatch = false;
            let resultsHtml = '<div class="alert alert-info"><h6>Test Results:</h6><ul class="mb-0">';
            
            patterns.forEach((patternStr, index) => {
                try {
                    const regex = new RegExp(patternStr, 'i');
                    const match = testSubject.match(regex);
                    
                    if (match && match[1]) {
                        resultsHtml += `<li><strong>Pattern ${index + 1}:</strong> ‚úÖ Matched "<code>${match[1]}</code>"</li>`;
                        if (!foundMatch) foundMatch = true;
                    } else {
                        resultsHtml += `<li><strong>Pattern ${index + 1}:</strong> ‚ùå No match</li>`;
                    }
                } catch (error) {
                    resultsHtml += `<li><strong>Pattern ${index + 1}:</strong> ‚ùå Invalid regex: ${error.message}</li>`;
                }
            });
            
            resultsHtml += '</ul>';
            
            if (foundMatch) {
                resultsHtml += '<div class="mt-2 text-success"><strong>‚úÖ Control number extraction will work!</strong></div>';
            } else {
                resultsHtml += '<div class="mt-2 text-danger"><strong>‚ùå No control number found - check your patterns</strong></div>';
            }
            
            resultsHtml += '</div>';
            resultDiv.innerHTML = resultsHtml;
        }

        // Load default patterns into form
        function loadDefaultPatterns() {
            loadPatternsIntoForm(getDefaultPatterns());
            document.getElementById('test-result').innerHTML = '';
        }

        // Save patterns
        async function savePatterns() {
            try {
                const configId = document.getElementById('edit-config-id').value;
                const patterns = Array.from(document.querySelectorAll('.pattern-input'))
                    .map(input => input.value.trim())
                    .filter(pattern => pattern.length > 0);
                
                if (patterns.length === 0) {
                    alert('Please add at least one pattern');
                    return;
                }
                
                // Validate patterns
                for (let i = 0; i < patterns.length; i++) {
                    try {
                        new RegExp(patterns[i]);
                    } catch (error) {
                        alert(`Pattern ${i + 1} is invalid: ${error.message}`);
                        return;
                    }
                }
                
                const response = await fetch(`/api/email-filing/config/${instanceId}/${configId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        control_number_patterns: patterns
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Control number patterns saved successfully!');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('patternsModal'));
                    modal.hide();
                    
                    // Refresh the configuration display
                    await displayConfigDetails();
                    await displayPatternConfigs(); // Also refresh pattern configs
                } else {
                    alert('Failed to save patterns: ' + data.message);
                }
            } catch (error) {
                alert('Error saving patterns: ' + error.message);
            }
        }

        // Show regex help modal
        function showRegexHelp() {
            const modal = new bootstrap.Modal(document.getElementById('regexHelpModal'));
            modal.show();
        }

        // Copy default pattern to clipboard
        async function copyDefaultPattern() {
            const defaultPattern = 'ID:\\\\s*(\\\\d{1,9})\\\\b';
            try {
                await navigator.clipboard.writeText(defaultPattern);
                
                // Show temporary success message
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.classList.remove('btn-primary');
                button.classList.add('btn-success');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-primary');
                }, 2000);
            } catch (error) {
                // Fallback for browsers that don't support clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = defaultPattern;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                alert('Default pattern copied to clipboard!');
            }
        }

        // Toggle email monitoring
        async function toggleEmailMonitoring() {
            const button = document.getElementById('toggle-monitoring');
            const icon = document.getElementById('monitoring-icon');
            const text = document.getElementById('monitoring-text');
            const status = document.getElementById('monitoring-status');
            
            const isCurrentlyRunning = icon.classList.contains('fa-stop');
            
            button.disabled = true;
            icon.className = 'fas fa-spinner fa-spin';
            text.textContent = isCurrentlyRunning ? 'Stopping...' : 'Starting...';
            
            try {
                const endpoint = isCurrentlyRunning ? 'stop-processing' : 'start-processing';
                const response = await fetch(`/api/email-filing/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ intervalMinutes: 5 })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (isCurrentlyRunning) {
                        // Stopped
                        icon.className = 'fas fa-play';
                        text.textContent = 'Start Monitoring';
                        button.classList.remove('btn-outline-danger');
                        button.classList.add('btn-outline-primary');
                        status.textContent = '‚ùå Not running';
                        status.className = 'text-danger';
                    } else {
                        // Started
                        icon.className = 'fas fa-stop';
                        text.textContent = 'Stop Monitoring';
                        button.classList.remove('btn-outline-primary');
                        button.classList.add('btn-outline-danger');
                        status.textContent = '‚úÖ Running every 5 minutes';
                        status.className = 'text-success';
                    }
                    
                    alert(data.message);
                } else {
                    alert('Failed to ' + (isCurrentlyRunning ? 'stop' : 'start') + ' monitoring: ' + data.message);
                }
            } catch (error) {
                alert('Error toggling monitoring: ' + error.message);
            } finally {
                button.disabled = false;
            }
        }

        // Check monitoring status on page load
        async function checkMonitoringStatus() {
            // Since monitoring auto-starts with server, assume it's running
            const icon = document.getElementById('monitoring-icon');
            const text = document.getElementById('monitoring-text');
            const button = document.getElementById('toggle-monitoring');
            const status = document.getElementById('monitoring-status');
            
            if (icon && text && button && status) {
                icon.className = 'fas fa-stop';
                text.textContent = 'Stop Monitoring';
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-outline-danger');
                status.textContent = '‚úÖ Running every 5 minutes';
                status.className = 'text-success';
            }
        }

        // Load email processing logs
        async function loadEmailLogs() {
            try {
                const response = await fetch(`/api/email-filing/logs/${instanceId}?limit=20`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                
                const statsDiv = document.getElementById('email-stats');
                
                if (data.success && data.logs && data.logs.length > 0) {
                    statsDiv.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date/Time</th>
                                        <th>Email</th>
                                        <th>Subject</th>
                                        <th>Control #</th>
                                        <th>Status</th>
                                        <th>Attachments</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.logs.map(log => {
                                        const date = new Date(log.processed_at).toLocaleString();
                                        const statusClass = log.processing_status === 'filed' ? 'success' : 
                                                          log.processing_status === 'error' ? 'danger' : 
                                                          log.processing_status === 'skipped' ? 'warning' : 'secondary';
                                        
                                        return `
                                            <tr>
                                                <td><small>${date}</small></td>
                                                <td><small title="${log.email_address || 'N/A'}">${(log.email_address || 'N/A').substring(0, 20)}${(log.email_address || '').length > 20 ? '...' : ''}</small></td>
                                                <td><small title="${log.subject || 'N/A'}">${(log.subject || 'N/A').substring(0, 30)}${(log.subject || '').length > 30 ? '...' : ''}</small></td>
                                                <td><span class="badge bg-info">${log.control_number || 'N/A'}</span></td>
                                                <td><span class="badge bg-${statusClass}">${log.processing_status}</span></td>
                                                <td><small>${log.attachments_count || 0}</small></td>
                                                <td>
                                                    ${log.processing_status === 'error' ? 
                                                        `<button class="btn btn-xs btn-outline-danger" onclick="showErrorDetails('${log.id}')" title="Show Error">
                                                            <i class="fas fa-exclamation-triangle"></i>
                                                        </button>` : 
                                                        log.filed_to_ims ? 
                                                            `<button class="btn btn-xs btn-outline-success" title="Filed to IMS">
                                                                <i class="fas fa-check"></i>
                                                            </button>` : ''
                                                    }
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h4 text-success">${data.logs.filter(l => l.processing_status === 'filed').length}</div>
                                        <small class="text-muted">Successful</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h4 text-danger">${data.logs.filter(l => l.processing_status === 'error').length}</div>
                                        <small class="text-muted">Errors</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h4 text-warning">${data.logs.filter(l => l.processing_status === 'skipped').length}</div>
                                        <small class="text-muted">Skipped</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h4 text-info">${data.logs.reduce((sum, l) => sum + (l.attachments_count || 0), 0)}</div>
                                        <small class="text-muted">Total Attachments</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    statsDiv.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>No email processing logs yet.</strong><br>
                            Send an email with a control number (e.g., "ID:12345") to your configured email address to see processing activity here.
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading email logs:', error);
                document.getElementById('email-stats').innerHTML = '<div class="alert alert-danger">Error loading email processing logs.</div>';
            }
        }

        // Refresh email logs
        async function refreshEmailLogs() {
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            button.disabled = true;
            
            try {
                await loadEmailLogs();
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Show error details for failed email processing
        async function showErrorDetails(logId) {
            try {
                const response = await fetch(`/api/email-filing/logs/${instanceId}?limit=100`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    const log = data.logs.find(l => l.id == logId);
                    if (log && log.error_message) {
                        alert(`Error Details:\\n\\nSubject: ${log.subject}\\nControl Number: ${log.control_number || 'Not found'}\\nError: ${log.error_message}`);
                    } else {
                        alert('No error details available.');
                    }
                }
            } catch (error) {
                alert('Error loading error details: ' + error.message);
            }
        }

        // Preview email address for managed setup
        document.getElementById('managed-email-prefix')?.addEventListener('input', async function() {
            const prefix = this.value.toLowerCase();
            if (prefix && instanceId) {
                try {
                    const response = await fetch(`/api/instances/${instanceId}`);
                    const data = await response.json();
                    
                    console.log('Instance data for email preview:', data);
                    
                    if (data.success && data.instance && data.instance.email_subdomain) {
                        document.getElementById('managed-email-preview').innerHTML = 
                            `Your email address will be: <strong>${prefix}-${data.instance.email_subdomain}@42ims.com</strong>`;
                    } else {
                        console.log('Instance missing email_subdomain:', data.instance);
                        document.getElementById('managed-email-preview').textContent = 
                            'This instance needs a subdomain configured. Please contact support.';
                    }
                } catch (error) {
                    console.error('Error loading subdomain:', error);
                    document.getElementById('managed-email-preview').textContent = 
                        'Error loading email preview. Please refresh the page.';
                }
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            // Auth check is handled by global-auth.js
            loadPageData();
            checkMonitoringStatus();
        });
    </script>
</body>
</html>