<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Filing - IMS Integration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --danger-color: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
        }

        .header {
            background: var(--primary-color);
            color: white;
            padding: 1rem;
            margin-bottom: 2rem;
        }

        .nav-links {
            margin-bottom: 1rem;
        }

        .nav-links a {
            color: var(--accent-color);
            text-decoration: none;
            margin-right: 1rem;
        }

        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-success { background-color: var(--success-color); color: white; }
        .status-error { background-color: var(--danger-color); color: white; }
        .status-pending { background-color: var(--warning-color); color: white; }
        .status-skipped { background-color: #6c757d; color: white; }

        .webhook-url {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.5rem;
            font-family: monospace;
            font-size: 0.875rem;
            word-break: break-all;
        }

        .copy-button {
            border: none;
            background: none;
            color: var(--accent-color);
            cursor: pointer;
            padding: 0.25rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .tab-content {
            margin-top: 1rem;
        }

        .log-row {
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 0;
        }

        .log-row:last-child {
            border-bottom: none;
        }

        .config-inactive {
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-envelope"></i> Email Filing Management</h1>
            <div class="nav-links">
                <a href="#" onclick="goBack()"><i class="fas fa-arrow-left"></i> Back to Instance</a>
                <a href="/dashboard"><i class="fas fa-home"></i> Dashboard</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Statistics Section -->
        <div class="stats-grid" id="statsContainer">
            <!-- Stats will be loaded here -->
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="configs-tab" data-bs-toggle="tab" data-bs-target="#configs" type="button" role="tab">
                    <i class="fas fa-cog"></i> Configurations
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">
                    <i class="fas fa-list"></i> Activity Log
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab">
                    <i class="fas fa-upload"></i> Manual Filing
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="help-tab" data-bs-toggle="tab" data-bs-target="#help" type="button" role="tab">
                    <i class="fas fa-question-circle"></i> Help
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <!-- Configurations Tab -->
            <div class="tab-pane fade show active" id="configs" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3 mt-3">
                    <h3>Email Filing Configurations</h3>
                    <button class="btn btn-primary" onclick="showCreateConfigModal()">
                        <i class="fas fa-plus"></i> New Configuration
                    </button>
                </div>
                
                <div id="configsContainer">
                    <!-- Configurations will be loaded here -->
                </div>
            </div>

            <!-- Activity Log Tab -->
            <div class="tab-pane fade" id="logs" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3 mt-3">
                    <h3>Email Filing Activity</h3>
                    <button class="btn btn-secondary" onclick="refreshLogs()">
                        <i class="fas fa-refresh"></i> Refresh
                    </button>
                </div>
                
                <div id="logsContainer">
                    <!-- Logs will be loaded here -->
                </div>
            </div>

            <!-- Manual Filing Tab -->
            <div class="tab-pane fade" id="manual" role="tabpanel">
                <div class="mt-3">
                    <h3>Manual Email Filing</h3>
                    <p class="text-muted">File an email manually for testing or one-off situations.</p>
                    
                    <form id="manualFilingForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="manualConfigSelect" class="form-label">Configuration</label>
                                    <select class="form-select" id="manualConfigSelect" required>
                                        <option value="">Select a configuration...</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="emailSubject" class="form-label">Email Subject</label>
                                    <input type="text" class="form-control" id="emailSubject" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="emailFrom" class="form-label">From Email</label>
                                    <input type="email" class="form-control" id="emailFrom" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="emailTo" class="form-label">To Email</label>
                                    <input type="email" class="form-control" id="emailTo">
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="emailBody" class="form-label">Email Body</label>
                                    <textarea class="form-control" id="emailBody" rows="10" required 
                                              placeholder="Paste the email content here. Control numbers will be automatically extracted."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="testControlNumberExtraction()">
                                <i class="fas fa-search"></i> Test Control Number Extraction
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> File Email
                            </button>
                        </div>
                        
                        <div id="extractionResults" class="mt-3" style="display: none;">
                            <!-- Extraction results will appear here -->
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Tab -->
            <div class="tab-pane fade" id="help" role="tabpanel">
                <div class="mt-3">
                    <h3>Setting Up Zapier Integration</h3>
                    
                    <div class="accordion" id="helpAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#zapierSetup">
                                    <i class="fas fa-play-circle me-2"></i> Step 1: Create Zapier Zap
                                </button>
                            </h2>
                            <div id="zapierSetup" class="accordion-collapse collapse show">
                                <div class="accordion-body">
                                    <ol>
                                        <li>Go to <a href="https://zapier.com" target="_blank">Zapier.com</a> and create an account</li>
                                        <li>Click "Create Zap"</li>
                                        <li>Choose "Outlook" or "Gmail" as your trigger app</li>
                                        <li>Select "New Email" or "New Email Matching Search" as the trigger</li>
                                        <li>Configure filters if needed (e.g., specific folder, subject contains text)</li>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#webhookSetup">
                                    <i class="fas fa-link me-2"></i> Step 2: Configure Webhook
                                </button>
                            </h2>
                            <div id="webhookSetup" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <ol>
                                        <li>Add an Action step in your Zap</li>
                                        <li>Choose "Webhooks by Zapier" as the action app</li>
                                        <li>Select "POST" as the action</li>
                                        <li>Copy the webhook URL from your configuration</li>
                                        <li>Set the request type to "JSON"</li>
                                        <li>Map the email fields (subject, body, from, etc.)</li>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#testing">
                                    <i class="fas fa-vial me-2"></i> Step 3: Testing
                                </button>
                            </h2>
                            <div id="testing" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <ol>
                                        <li>Use the test functionality in your configuration</li>
                                        <li>Send a test email with a control number</li>
                                        <li>Check the Activity Log for results</li>
                                        <li>Verify the document was filed in IMS</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Configuration Modal -->
    <div class="modal fade" id="createConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Email Filing Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="createConfigForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="configName" class="form-label">Configuration Name</label>
                            <input type="text" class="form-control" id="configName" required 
                                   placeholder="e.g., Customer Service Emails">
                        </div>
                        
                        <div class="mb-3">
                            <label for="configDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="configDescription" rows="2" 
                                      placeholder="Brief description of this configuration"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="defaultFolderId" class="form-label">Default IMS Folder ID</label>
                                    <input type="number" class="form-control" id="defaultFolderId" 
                                           placeholder="Optional - IMS folder ID">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3 form-check mt-4">
                                    <input type="checkbox" class="form-check-input" id="autoExtract" checked>
                                    <label class="form-check-label" for="autoExtract">
                                        Auto-extract control numbers
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="controlPatterns" class="form-label">Control Number Patterns</label>
                            <textarea class="form-control" id="controlPatterns" rows="4" 
                                      placeholder="One regex pattern per line. Leave blank for defaults."></textarea>
                            <div class="form-text">
                                Default patterns: Control numbers 1-9 digits in subject line (optionally preceded by "RE:")
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="fileAsPdf" checked>
                                    <label class="form-check-label" for="fileAsPdf">
                                        Convert email to PDF
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="includeAttachments" checked>
                                    <label class="form-check-label" for="includeAttachments">
                                        Include attachments
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Configuration</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/global-auth.js"></script>
    <script>
        let currentInstanceId;
        let currentConfigs = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/';
                return;
            }

            // Get instance ID from URL
            const pathParts = window.location.pathname.split('/');
            currentInstanceId = pathParts[2];

            // Load initial data
            loadStats();
            loadConfigs();
            loadLogs();
            loadConfigsForManualForm();
        });

        function goBack() {
            window.location.href = `/instance/${currentInstanceId}`;
        }

        async function loadStats() {
            try {
                const response = await fetch(`/api/email-filing/stats?instance_id=${currentInstanceId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const { stats } = await response.json();
                    displayStats(stats);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function displayStats(stats) {
            const container = document.getElementById('statsContainer');
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total_emails}</div>
                    <div class="stat-label">Total Emails</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number text-success">${stats.successful}</div>
                    <div class="stat-label">Successfully Filed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number text-danger">${stats.errors}</div>
                    <div class="stat-label">Errors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number text-warning">${stats.pending}</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.today}</div>
                    <div class="stat-label">Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.this_week}</div>
                    <div class="stat-label">This Week</div>
                </div>
            `;
        }

        async function loadConfigs() {
            try {
                const response = await fetch(`/api/email-filing/configs?instance_id=${currentInstanceId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const { configs } = await response.json();
                    currentConfigs = configs;
                    displayConfigs(configs);
                } else {
                    document.getElementById('configsContainer').innerHTML = 
                        '<div class="alert alert-warning">Failed to load configurations</div>';
                }
            } catch (error) {
                console.error('Error loading configs:', error);
                document.getElementById('configsContainer').innerHTML = 
                    '<div class="alert alert-danger">Error loading configurations</div>';
            }
        }

        function displayConfigs(configs) {
            const container = document.getElementById('configsContainer');
            
            if (configs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5>No Email Filing Configurations</h5>
                        <p class="text-muted">Create your first configuration to start filing emails automatically.</p>
                        <button class="btn btn-primary" onclick="showCreateConfigModal()">
                            <i class="fas fa-plus"></i> Create Configuration
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = configs.map(config => `
                <div class="card ${config.is_active ? '' : 'config-inactive'}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title">
                                    ${config.name}
                                    ${config.is_active ? 
                                        '<span class="status-badge status-success ms-2">Active</span>' : 
                                        '<span class="status-badge status-skipped ms-2">Inactive</span>'
                                    }
                                </h5>
                                <p class="text-muted mb-2">Instance: ${config.instance_name}</p>
                                
                                <div class="mb-3">
                                    <small class="text-muted">Webhook URL:</small>
                                    <div class="webhook-url">
                                        ${window.location.origin}/api/webhooks/zapier/${config.config_id}/email
                                        <button class="copy-button float-end" onclick="copyWebhookUrl('${config.config_id}')" title="Copy to clipboard">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted d-block">Auto-extract Control Numbers:</small>
                                        <span class="badge bg-${config.auto_extract_control_numbers ? 'success' : 'secondary'}">
                                            ${config.auto_extract_control_numbers ? 'Yes' : 'No'}
                                        </span>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted d-block">Include Attachments:</small>
                                        <span class="badge bg-${config.include_attachments ? 'success' : 'secondary'}">
                                            ${config.include_attachments ? 'Yes' : 'No'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    Actions
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="testWebhook('${config.config_id}')">
                                        <i class="fas fa-vial"></i> Test Webhook
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="toggleConfig('${config.config_id}', ${!config.is_active})">
                                        <i class="fas fa-power-off"></i> ${config.is_active ? 'Disable' : 'Enable'}
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteConfig('${config.config_id}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadLogs() {
            try {
                const response = await fetch(`/api/email-filing/logs?instance_id=${currentInstanceId}&limit=50`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const { logs } = await response.json();
                    displayLogs(logs);
                } else {
                    document.getElementById('logsContainer').innerHTML = 
                        '<div class="alert alert-warning">Failed to load activity logs</div>';
                }
            } catch (error) {
                console.error('Error loading logs:', error);
                document.getElementById('logsContainer').innerHTML = 
                    '<div class="alert alert-danger">Error loading activity logs</div>';
            }
        }

        function displayLogs(logs) {
            const container = document.getElementById('logsContainer');
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-list fa-3x text-muted mb-3"></i>
                        <h5>No Activity Yet</h5>
                        <p class="text-muted">Email filing activity will appear here once you start processing emails.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = logs.map(log => `
                <div class="log-row">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <span class="status-badge status-${log.status} me-2">${log.status.charAt(0).toUpperCase() + log.status.slice(1)}</span>
                                <strong>${log.email_subject || 'No Subject'}</strong>
                            </div>
                            
                            <div class="row text-muted small">
                                <div class="col-md-3">
                                    <i class="fas fa-envelope me-1"></i> ${log.email_from || 'Unknown'}
                                </div>
                                <div class="col-md-3">
                                    <i class="fas fa-hashtag me-1"></i> ${log.control_number_used || 'None found'}
                                </div>
                                <div class="col-md-3">
                                    <i class="fas fa-cog me-1"></i> ${log.config_name || 'Unknown config'}
                                </div>
                                <div class="col-md-3">
                                    <i class="fas fa-clock me-1"></i> ${new Date(log.processed_at).toLocaleString()}
                                </div>
                            </div>
                            
                            ${log.error_message ? `
                                <div class="alert alert-danger alert-sm mt-2 mb-0">
                                    <i class="fas fa-exclamation-triangle me-1"></i> ${log.error_message}
                                </div>
                            ` : ''}
                            
                            ${log.document_guid ? `
                                <div class="text-success small mt-1">
                                    <i class="fas fa-check me-1"></i> Filed as document: ${log.document_guid}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showCreateConfigModal() {
            new bootstrap.Modal(document.getElementById('createConfigModal')).show();
        }

        document.getElementById('createConfigForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('configName').value,
                instanceId: currentInstanceId,
                defaultFolderId: document.getElementById('defaultFolderId').value || null,
                autoExtractControlNumbers: document.getElementById('autoExtract').checked,
                controlNumberPatterns: document.getElementById('controlPatterns').value,
                fileEmailAsPdf: document.getElementById('fileAsPdf').checked,
                includeAttachments: document.getElementById('includeAttachments').checked
            };

            try {
                const response = await fetch('/api/email-filing/configs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('createConfigModal')).hide();
                    document.getElementById('createConfigForm').reset();
                    loadConfigs();
                    loadStats();
                    showAlert('Configuration created successfully!', 'success');
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Failed to create configuration', 'danger');
                }
            } catch (error) {
                console.error('Error creating config:', error);
                showAlert('Error creating configuration', 'danger');
            }
        });

        async function copyWebhookUrl(configId) {
            const url = `${window.location.origin}/api/webhooks/zapier/${configId}/email`;
            try {
                await navigator.clipboard.writeText(url);
                showAlert('Webhook URL copied to clipboard!', 'info');
            } catch (error) {
                console.error('Failed to copy URL:', error);
                showAlert('Failed to copy URL', 'warning');
            }
        }

        async function testWebhook(configId) {
            try {
                const response = await fetch(`/api/webhooks/zapier/${configId}/test`);
                const result = await response.json();
                
                if (response.ok) {
                    showAlert(`Webhook test successful! Config: ${result.config_name}`, 'success');
                } else {
                    showAlert(result.message || 'Webhook test failed', 'danger');
                }
            } catch (error) {
                console.error('Webhook test error:', error);
                showAlert('Webhook test failed', 'danger');
            }
        }

        async function toggleConfig(configId, isActive) {
            try {
                const response = await fetch(`/api/email-filing/configs/${configId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ is_active: isActive })
                });

                if (response.ok) {
                    loadConfigs();
                    showAlert(`Configuration ${isActive ? 'enabled' : 'disabled'}`, 'success');
                } else {
                    showAlert('Failed to update configuration', 'danger');
                }
            } catch (error) {
                console.error('Error toggling config:', error);
                showAlert('Error updating configuration', 'danger');
            }
        }

        async function deleteConfig(configId) {
            if (!confirm('Are you sure you want to delete this configuration? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/email-filing/configs/${configId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    loadConfigs();
                    loadStats();
                    showAlert('Configuration deleted', 'success');
                } else {
                    showAlert('Failed to delete configuration', 'danger');
                }
            } catch (error) {
                console.error('Error deleting config:', error);
                showAlert('Error deleting configuration', 'danger');
            }
        }

        function loadConfigsForManualForm() {
            // This will be called when the manual tab is shown
            const select = document.getElementById('manualConfigSelect');
            select.innerHTML = '<option value="">Select a configuration...</option>' +
                currentConfigs.filter(c => c.is_active).map(config => 
                    `<option value="${config.config_id}">${config.name}</option>`
                ).join('');
        }

        async function testControlNumberExtraction() {
            const emailContent = {
                subject: document.getElementById('emailSubject').value,
                body: document.getElementById('emailBody').value
            };

            try {
                const response = await fetch('/api/email-filing/test-extraction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ emailContent })
                });

                if (response.ok) {
                    const result = await response.json();
                    displayExtractionResults(result.control_numbers);
                } else {
                    showAlert('Failed to test control number extraction', 'danger');
                }
            } catch (error) {
                console.error('Error testing extraction:', error);
                showAlert('Error testing control number extraction', 'danger');
            }
        }

        function displayExtractionResults(controlNumbers) {
            const container = document.getElementById('extractionResults');
            
            if (controlNumbers.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No control numbers found in the email content.
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check me-2"></i>
                        Found ${controlNumbers.length} control number(s): 
                        <strong>${controlNumbers.join(', ')}</strong>
                    </div>
                `;
            }
            
            container.style.display = 'block';
        }

        document.getElementById('manualFilingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const emailData = {
                subject: document.getElementById('emailSubject').value,
                from: document.getElementById('emailFrom').value,
                to: document.getElementById('emailTo').value,
                body_text: document.getElementById('emailBody').value,
                date: new Date().toISOString()
            };

            const configId = document.getElementById('manualConfigSelect').value;

            try {
                const response = await fetch('/api/email-filing/manual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ configId, emailData })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showAlert(`Email filed successfully! Control number: ${result.control_number}`, 'success');
                    document.getElementById('manualFilingForm').reset();
                    document.getElementById('extractionResults').style.display = 'none';
                    loadLogs();
                    loadStats();
                } else {
                    showAlert(result.message || 'Failed to file email', 'danger');
                }
            } catch (error) {
                console.error('Error filing email:', error);
                showAlert('Error filing email manually', 'danger');
            }
        });

        function refreshLogs() {
            loadLogs();
            showAlert('Activity log refreshed', 'info');
        }

        function showAlert(message, type = 'info') {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999;" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', alertHtml);
        }

        // Load configs when manual tab is shown
        document.getElementById('manual-tab').addEventListener('shown.bs.tab', loadConfigsForManualForm);
    </script>
</body>
</html>